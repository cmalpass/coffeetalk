@using CoffeeTalk.Gui.Services
@using CoffeeTalk.Gui.Components.Pages
@using MudBlazor
@namespace CoffeeTalk.Gui.Components
@inject BlazorUserInterface UI
@inject AppState AppState
@inject ISnackbar Snackbar

<MudGrid>
    <MudItem xs="12" sm="4" md="3">
        <MudPaper Class="pa-4" Elevation="4" Style="height: 80vh; overflow-y: auto;">
            <MudText Typo="Typo.h6" Class="mb-4">Document State</MudText>
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                @UI.DocumentContent
            </MudText>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="8" md="9">
        <MudPaper Class="pa-4 d-flex flex-column" Elevation="4" Style="height: 80vh;">
            <MudStack Row="true" Class="mb-2">
                 @if (!string.IsNullOrEmpty(UI.StatusMessage))
                {
                    <MudAlert Severity="Severity.Info" Class="flex-grow-1">@UI.StatusMessage</MudAlert>
                }
                <MudSpacer />
                <MudButton StartIcon="@Icons.Material.Filled.Save" Variant="Variant.Filled" Color="Color.Secondary" OnClick="SaveChat">Save Chat</MudButton>
            </MudStack>

            <MudList T="string" Class="flex-grow-1 overflow-y-auto" Style="max-height: 100%;">
                @foreach (var msg in UI.Messages)
                {
                    if (msg.IsDivider)
                    {
                        <MudDivider Class="my-2" />
                        @if (!string.IsNullOrEmpty(msg.Content))
                        {
                            <MudText Align="Align.Center" Color="Color.Secondary" Typo="Typo.caption">@msg.Content</MudText>
                        }
                    }
                    else
                    {
                        <MudListItem T="string">
                            <MudCard Class="@GetMessageClass(msg)" Elevation="2">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        @if (!msg.IsSystem && !msg.IsError)
                                        {
                                            <MudText Typo="Typo.subtitle2" Color="Color.Primary">@msg.Sender</MudText>
                                        }
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@msg.Content</MudText>
                                </MudCardContent>
                            </MudCard>
                        </MudListItem>
                    }
                }
            </MudList>

            @if (UI.IsInterventionRequired)
            {
                <MudPaper Class="pa-3 mt-3" Elevation="3">
                    <MudText Typo="Typo.h6">Director's Chair</MudText>
                    <MudStack Row="true" Spacing="2" Class="mt-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick='() => Submit("continue", "")'>Continue</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick='() => Submit("quit", "")'>End Conversation</MudButton>
                    </MudStack>
                    <MudStack Row="true" Spacing="2" Class="mt-2">
                        <MudTextField @bind-Value="FeedbackMessage" Label="Inject direction/feedback..." Variant="Variant.Outlined" Margin="Margin.Dense" FullWidth="true" />
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick='() => Submit("inject", FeedbackMessage)'>Inject</MudButton>
                    </MudStack>
                </MudPaper>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string FeedbackMessage = "";

    protected override void OnInitialized()
    {
        UI.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        UI.OnChange -= StateHasChanged;
    }

    private void Submit(string action, string message)
    {
        UI.SubmitIntervention(action, message);
        FeedbackMessage = "";
    }

    private string GetMessageClass(ChatMessage msg)
    {
        if (msg.IsSystem) return "pa-2 mb-2 bg-info-subtle";
        if (msg.IsError) return "pa-2 mb-2 bg-danger-subtle";
        return "pa-2 mb-2";
    }

    private async Task SaveChat()
    {
        // We can access the document via UI if we expose it or via a service.
        // Currently UI.DocumentContent is a string snapshot.
        // To save properly we might want to use the actual document instance or just save what we have.
        // Ideally, the Orchestrator handles saving, but here we want to trigger it manually.
        // For now, let's just save the text we have in the UI to a file in current directory.
        // In a real desktop app, we'd open a file picker.

        try
        {
            var fileName = $"conversation_{DateTime.Now:yyyyMMdd_HHmmss}.md";
            await File.WriteAllTextAsync(fileName, UI.DocumentContent);
            Snackbar.Add($"Saved to {fileName}", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to save: {ex.Message}", Severity.Error);
        }
    }
}
