@using CoffeeTalk.Gui.Services
@using CoffeeTalk.Gui.Components.Pages
@using MudBlazor
@using Microsoft.JSInterop
@namespace CoffeeTalk.Gui.Components
@implements IDisposable
@inject BlazorUserInterface UI
@inject AppState AppState
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudGrid Style="height: calc(100vh - 80px);">
    <!-- Document Panel -->
    <MudItem xs="12" md="4" Class="d-flex flex-column" Style="height: 100%;">
        <MudPaper Elevation="4" Class="d-flex flex-column flex-grow-1 overflow-hidden">
            <MudToolBar Dense="true" Class="mud-theme-primary">
                <MudText Typo="Typo.h6" Color="Color.Inherit">Document State</MudText>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Save" Color="Color.Inherit" OnClick="SaveChat" Title="Save Chat" />
            </MudToolBar>
            <MudPaper Class="pa-4 flex-grow-1 overflow-y-auto mud-background-gray">
                <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace;">
                    @UI.DocumentContent
                </MudText>
            </MudPaper>
        </MudPaper>
    </MudItem>

    <!-- Chat Panel -->
    <MudItem xs="12" md="8" Class="d-flex flex-column" Style="height: 100%;">
        <MudPaper Elevation="4" Class="d-flex flex-column flex-grow-1 overflow-hidden">
             @if (!string.IsNullOrEmpty(UI.StatusMessage))
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="rounded-0">@UI.StatusMessage</MudAlert>
            }

            <!-- Messages Area -->
            <div class="flex-grow-1 overflow-y-auto pa-4" id="chat-container">
                @foreach (var msg in UI.Messages)
                {
                    if (msg.IsDivider)
                    {
                        <MudDivider Class="my-4" />
                        @if (!string.IsNullOrEmpty(msg.Content))
                        {
                            <MudText Align="Align.Center" Color="Color.Secondary" Typo="Typo.caption" Class="d-block mb-2">@msg.Content</MudText>
                        }
                    }
                    else if (msg.IsSystem)
                    {
                         <div class="d-flex justify-center mb-2">
                            <MudChip T="string" Color="Color.Info" Size="Size.Small" Variant="Variant.Text">@msg.Content</MudChip>
                        </div>
                    }
                    else if (msg.IsError)
                    {
                        <MudAlert Severity="Severity.Error" Dense="true" Class="mb-2">@msg.Content</MudAlert>
                    }
                    else
                    {
                        <!-- Agent/User Message Bubble -->
                        <div class="d-flex flex-column mb-3 @(msg.Sender == "Director (User)" ? "align-end" : "align-start")">
                            <MudText Typo="Typo.caption" Class="ml-2 mb-1" Color="Color.Secondary">@msg.Sender</MudText>
                            <MudPaper Class="pa-3 rounded-lg" MaxWidth="80%"
                                      Style="@(msg.Sender == "Director (User)" ? $"background-color:{Colors.Brown.Default}; color:white;" : $"background-color:{Colors.Gray.Lighten4};")">
                                <MudText Typo="Typo.body1" Color="@(msg.Sender == "Director (User)" ? Color.Surface : Color.Default)" Style="white-space: pre-wrap;">
                                    @msg.Content
                                </MudText>
                            </MudPaper>
                        </div>
                    }
                }
            </div>

            <!-- Interaction Area -->
            @if (UI.IsInterventionRequired)
            {
                <MudPaper Class="pa-3 z-10" Elevation="8">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary" GutterBottom="true">Director's Chair</MudText>

                    <MudGrid>
                        <MudItem xs="12">
                             <MudTextField @bind-Value="FeedbackMessage" Placeholder="Enter instructions or feedback..." Variant="Variant.Outlined" Margin="Margin.Dense" FullWidth="true"
                                           Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Send" OnAdornmentClick='() => Submit("inject", FeedbackMessage)' />
                        </MudItem>
                        <MudItem xs="12" Class="d-flex gap-2">
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick='() => Submit("continue", "")'>Continue</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick='() => Submit("inject", FeedbackMessage)'>Inject</MudButton>
                            <MudSpacer />
                            <MudButton Variant="Variant.Text" Color="Color.Error" StartIcon="@Icons.Material.Filled.Stop" OnClick='() => Submit("quit", "")'>Stop</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string FeedbackMessage = "";

    protected override void OnInitialized()
    {
        UI.OnChange += StateHasChanged;
        UI.OnChange += OnChangeScrollToBottom;
    }

    public void Dispose()
    {
        UI.OnChange -= StateHasChanged;
        UI.OnChange -= OnChangeScrollToBottom;
    }

    private void OnChangeScrollToBottom()
    {
        _ = ScrollToBottomAsync();
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "chat-container");
        }
        catch
        {
            // Silently ignore scroll errors as this is a nice-to-have feature
        }
    }

    private void Submit(string action, string message)
    {
        UI.SubmitIntervention(action, message);
        FeedbackMessage = "";
    }

    private async Task SaveChat()
    {
        try
        {
            var fileName = $"conversation_{DateTime.Now:yyyyMMdd_HHmmss}.md";
            await File.WriteAllTextAsync(fileName, UI.DocumentContent);
            Snackbar.Add($"Saved to {fileName}", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to save: {ex.Message}", Severity.Error);
        }
    }
}
