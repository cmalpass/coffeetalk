@page "/"
@using CoffeeTalk.Models
@using CoffeeTalk.Services
@using CoffeeTalk.Core.Interfaces
@using CoffeeTalk.Gui.Services
@using CoffeeTalk.Gui.Components.Pages
@using MudBlazor
@namespace CoffeeTalk.Gui.Components.Pages

@inject AppState AppState
@inject BlazorUserInterface UI
@inject NavigationManager Navigation


<MudContainer MaxWidth="MaxWidth.Small" Class="mt-5">
    <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">CoffeeTalk Setup</MudText>

    <MudCard Elevation="3">
        <MudCardContent>
            <MudTextField @bind-Value="Topic" Label="What would you like to discuss?" Variant="Variant.Outlined" Margin="Margin.Normal" FullWidth="true" />

            <MudText Typo="Typo.subtitle1" Class="mt-4 mb-2">Active Personas</MudText>
            <MudChipSet T="object" MultiSelection="true" @bind-SelectedValues="SelectedPersonas">
                @foreach (var persona in AppState.Settings.Personas)
                {
                    <MudChip T="object" Value="@((object)persona)" Text="@persona.Name" Color="Color.Primary" Variant="Variant.Outlined" SelectedColor="Color.Primary" />
                }
            </MudChipSet>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="StartConversation" FullWidth="true" Disabled="@(string.IsNullOrWhiteSpace(Topic) || SelectedPersonas == null || SelectedPersonas.Count < 2)">Start Conversation</MudButton>
        </MudCardActions>
    </MudCard>

    <MudAlert Severity="Severity.Info" Class="mt-4">
        Using Provider: <strong>@AppState.Settings.LlmProvider.Type</strong><br/>
        Model: <strong>@AppState.Settings.LlmProvider.ModelId</strong>
    </MudAlert>
</MudContainer>

@code {
    private string Topic = "";

    // MudChipSet binding expects IReadOnlyCollection for SelectedValues in newer versions usually?
    // The error said "cannot convert ICollection to IReadOnlyCollection".
    // Let's use IReadOnlyCollection.
    private IReadOnlyCollection<object> SelectedPersonas { get; set; } = new List<object>();

    protected override void OnInitialized()
    {
        // Select all by default
        SelectedPersonas = AppState.Settings.Personas.Cast<object>().ToList();
    }

    private async Task StartConversation()
    {
        if (string.IsNullOrWhiteSpace(Topic)) return;
        if (SelectedPersonas == null || SelectedPersonas.Count < 2) return;

        // We need to run the conversation in a background task so it doesn't block the UI thread
        _ = Task.Run(async () => {
             try
             {
                // We need to replicate Program.cs setup logic here but using the UI service
                var sharedDoc = new CollaborativeMarkdownDocument();
                var markdownTools = new MarkdownToolFunctions(sharedDoc);
                var tools = markdownTools.CreateTools();
                var settings = AppState.Settings;
                var rateLimiter = new RateLimiter(settings.RateLimit);

                var activePersonasConfig = SelectedPersonas.Cast<PersonaConfig>().ToList();

                var activePersonas = new List<AgentPersona>();
                foreach (var personaConfig in activePersonasConfig)
                {
                    var agent = AgentBuilder.CreateAgent(
                        settings.LlmProvider,
                        personaConfig.Name,
                        personaConfig.SystemPrompt,
                        tools);

                    var agentPersona = new AgentPersona(
                        agent,
                        personaConfig,
                        sharedDoc,
                        rateLimiter,
                        settings.MaxConversationTurns,
                        activePersonasConfig.Count);

                    activePersonas.Add(agentPersona);
                }

                // (Simplified setup - skipping orchestrator/editor optional checks for brevity in this initial pass,
                // but can be added similarly to CLI Program.cs)

                var conversationOrchestrator = new AgentConversationOrchestrator(
                    UI, // Inject our Blazor UI
                    activePersonas,
                    sharedDoc,
                    settings
                    // nulls for optional components for now
                );

                await conversationOrchestrator.StartConversationAsync(Topic);
             }
             catch(Exception ex)
             {
                 await UI.ShowErrorAsync(ex.ToString());
             }
        });

        Navigation.NavigateTo("/conversation");
    }
}
