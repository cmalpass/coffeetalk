@page "/"
@using CoffeeTalk.Models
@using CoffeeTalk.Services
@using CoffeeTalk.Core.Interfaces
@using CoffeeTalk.Gui.Services
@using CoffeeTalk.Gui.Components.Pages
@namespace CoffeeTalk.Gui.Components.Pages

@inject ConfigurationService ConfigService
@inject BlazorUserInterface UI
@inject NavigationManager Navigation


<MudContainer MaxWidth="MaxWidth.Small" Class="mt-5">
    <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">CoffeeTalk Setup</MudText>

    @if (!ConfigLoaded)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudCard Elevation="3">
            <MudCardContent>
                <MudTextField @bind-Value="Topic" Label="What would you like to discuss?" Variant="Variant.Outlined" Margin="Margin.Normal" FullWidth="true" />
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="StartConversation" FullWidth="true">Start Conversation</MudButton>
            </MudCardActions>
        </MudCard>

        <MudAlert Severity="Severity.Info" Class="mt-4">
            Using Provider: <strong>@Settings.LlmProvider.Type</strong><br/>
            Model: <strong>@Settings.LlmProvider.ModelId</strong>
        </MudAlert>
    }
</MudContainer>

@code {
    private AppSettings Settings = new();
    private bool ConfigLoaded = false;
    private string Topic = "";

    protected override void OnInitialized()
    {
        Settings = ConfigService.LoadConfiguration();
        ConfigLoaded = true;
    }

    private async Task StartConversation()
    {
        if (string.IsNullOrWhiteSpace(Topic)) return;

        // In a real app we might want to validate/configure settings via UI if missing.
        // For this demo, we assume appsettings.json is populated or we accept defaults.

        // We need to run the conversation in a background task so it doesn't block the UI thread
        _ = Task.Run(async () => {
             try
             {
                // We need to replicate Program.cs setup logic here but using the UI service
                var sharedDoc = new CollaborativeMarkdownDocument();
                var markdownTools = new MarkdownToolFunctions(sharedDoc);
                var tools = markdownTools.CreateTools();
                var rateLimiter = new RateLimiter(Settings.RateLimit);

                var agentPersonas = new List<AgentPersona>();
                foreach (var personaConfig in Settings.Personas)
                {
                    var agent = AgentBuilder.CreateAgent(
                        Settings.LlmProvider,
                        personaConfig.Name,
                        personaConfig.SystemPrompt,
                        tools);

                    var agentPersona = new AgentPersona(
                        agent,
                        personaConfig,
                        sharedDoc,
                        rateLimiter,
                        Settings.MaxConversationTurns,
                        Settings.Personas.Count);

                    agentPersonas.Add(agentPersona);
                }

                // (Simplified setup - skipping orchestrator/editor optional checks for brevity in this initial pass,
                // but can be added similarly to CLI Program.cs)

                var conversationOrchestrator = new AgentConversationOrchestrator(
                    UI, // Inject our Blazor UI
                    agentPersonas,
                    sharedDoc,
                    Settings
                    // nulls for optional components for now
                );

                await conversationOrchestrator.StartConversationAsync(Topic);
             }
             catch(Exception ex)
             {
                 await UI.ShowErrorAsync(ex.ToString());
             }
        });

        // Navigate to conversation view (actually we can just swap components or use router)
        // Since we are using a simple layout, let's just use the router to go to a conversation page.
        // However, we need to pass state.
        // Better: Make Conversation.razor the main view and switch mode.
        // Or just redirect and let the service hold the state (Singleton).
        Navigation.NavigateTo("/conversation");
    }
}
